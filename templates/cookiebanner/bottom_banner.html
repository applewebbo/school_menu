{% load heroicons i18n %}
<div id="cookiebannerModal"
     tabindex="-1"
     class="hidden fixed bottom-0 z-50 justify-between p-4 w-full bg-gray-50 border-t border-gray-300 start-0">
  <div class="py-3 px-5 m-auto max-w-screen-lg md:py-4 md:px-6" x-data="{ openChoices : false }">
    <h3 class="text-xl font-semibold text-center text-gray-900 sm:text-left">{{ cb_settings.title }}</h3>
    {% if cb_settings.header_text %}
      <p class="mt-3 text-center sm:text-left">{{ cb_settings.header_text|safe }}</p>
    {% endif %}
    <form id="cookiebannerForm" class="my-3">
      {% for cookiegroup in cb_settings.groups %}
        <div id="cookiegroup_{{ cookiegroup.id }}">
          <div class="form-control">
            <label class="cursor-pointer label">
              <span class="label-text">{{ cookiegroup.name }}</span>
              <input type="checkbox"
                     class="checkbox checkbox-success"
                     name="{{ cookiegroup.id }}"
                     {% if not cookiegroup.optional %}checked disabled{% endif %}>
            </label>
          </div>
        </div>
      {% endfor %}
    </form>
    <div id="cookiebannerModalBody">
      <div id="choicesCollapse"
           x-cloak
           x-show="openChoices"
           x-collapse
           x-collapse.duration.500ms>
        {% for cookiegroup in cb_settings.groups %}
          <div>
            <p class="flex gap-1 items-center px-5 mb-2 text-xs">
              {% heroicon_mini 'information-circle' class="size-4 text-info" %}{{ cookiegroup.description }}
            </p>
            <div class="px-4 text-pretty">
              <table class="table table-xs table-zebra">
                {% for cookie in cookiegroup.cookies %}
                  <tr>
                    <td>{{ cookie.pattern }}</td>
                    <td>{{ cookie.description }}</td>
                  </tr>
                {% endfor %}
              </table>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    <div id="cookiebannerModalFooter"
         class="flex gap-2 justify-center items-center py-3 px-5 md:justify-end md:py-4 md:px-6">
      {% if cb_settings.footer_text %}<p class="text-left">{{ cb_settings.footer_text|safe }}</p>{% endif %}
      <button type="button"
              class="btn btn-sm btn-secondary"
              x-on:click="openChoices = ! openChoices"
              x-show="!openChoices">{% heroicon_mini 'plus-circle' class="size-5" %}Info</button>
      <button type="button"
              class="btn btn-sm btn-secondary"
              x-on:click="openChoices = ! openChoices"
              x-show="openChoices">{% heroicon_mini 'minus-circle' class="size-5" %}Info</button>
      <input type="submit"
             name="enable_all"
             class="btn btn-sm btn-primary"
             value="Accetta">
      <ul class="menu menu-horizontal">
        {% for link in cb_settings.footer_links %}
          <li>
            <a class="link link-primary" href="{{ link.href }}">{{ link.title }}</a>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
      const cookiegroups = JSON.parse("{{ cookiegroups_json|escapejs }}");
      const cookieBannerModal = document.getElementById('cookiebannerModal');

      function checkExistingCookies() {
        const savedCookieValue = getCookie('cookiebanner');
        if (!savedCookieValue) {
          cookieBannerModal.classList.remove('hidden');
          cookieBannerModal.classList.add('flex');
        }
      }

      checkExistingCookies();

      function getCookie(name) {
        let cookieArray = document.cookie.split(';');
        for (let i = 0; i < cookieArray.length; i++) {
          let cookie = cookieArray[i];
          while (cookie.charAt(0) == ' ') {
            cookie = cookie.substring(1);
          }
          if (cookie.indexOf(name + "=") == 0) {
            return cookie.substring(name.length + 1, cookie.length);
          }
        }
        return "";
      }

      function setCookie(name, value, days) {
        let expires = "";
        if (days) {
          let date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
      }

      function restoreCheckboxStates() {
        const savedCookieValue = getCookie('cookiebanner');
        if (savedCookieValue) {
          const savedValues = savedCookieValue.split(',');
          document.querySelectorAll("#cookiebannerForm input[type='checkbox']").forEach((checkbox) => {
            checkbox.checked = savedValues.includes(checkbox.name);
          });
        }
      }

      restoreCheckboxStates();

      document.body.addEventListener('click', function (event) {
        if (event.target.matches("a[data-toggle='cookiebannerCollapse']")) {
          event.preventDefault();
          const targetId = event.target.getAttribute('href').substring(1);
          const detailElement = document.getElementById(targetId);
          if (detailElement) {
            detailElement.classList.toggle('show');
          }
        }
      });

      document.querySelectorAll("input[type='submit']").forEach((button) => {
        button.addEventListener("click", function (event) {
          event.preventDefault();
          let enable_cookies = [];
          if (button.name === 'enable_all') {
            enable_cookies = cookiegroups.map(group => group.id);
            document.getElementById('cookiebannerModal').classList.add('hidden');
          } else {
            document.querySelectorAll("#cookiebannerForm input[type='checkbox']:checked").forEach((checkbox) => {
              enable_cookies.push(checkbox.name);
            });
          }

          setCookie('cookiebanner', enable_cookies.join(','), 365);
          window.location.reload();
        });
      });
    });
</script>
